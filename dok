# DÃ©ploiement dâ€™un GitLab Runner dans Podman avec support Flatpak â€“ Debian 12

Cette documentation guide pas Ã  pas lâ€™installation et lâ€™explication de chaque commande pour comprendre **ce quâ€™on fait et pourquoi**.

---

## ğŸ¯ Objectif

Configurer une VM Debian 12 pour hÃ©berger un **GitLab Runner dans Podman**, capable de :

- S'enregistrer auprÃ¨s d'une instance GitLab
- ExÃ©cuter des jobs de CI/CD
- Lancer des conteneurs via Podman (`Podman-outside-of-Podman`)
- Supporter des builds Flatpak (via `flatpak` et `flatpak-builder`)

---

## ğŸ§¾ PrÃ©requis

- Une VM Debian 12 (accÃ¨s root ou `sudo`)
- Podman dÃ©jÃ  installÃ© (`podman --version`)
- Connexion Ã  Internet
- AccÃ¨s Ã  une instance GitLab avec un projet
- Un token dâ€™enregistrement de runner (projet ou global)

---

## ğŸ§± Ã‰tape 1 â€“ Installer les outils nÃ©cessaires

```bash
sudo apt update
sudo apt install -y \
  podman \
  uidmap \
  slirp4netns \
  fuse-overlayfs \
  flatpak \
  flatpak-builder \
  curl \
  git \
  gnupg \
  lsb-release \
  ca-certificates \
  software-properties-common
```

### ğŸ’¡ Pourquoi ?

- `podman`, `uidmap`, `slirp4netns`, `fuse-overlayfs` : nÃ©cessaires pour faire tourner des conteneurs rootless.
- `flatpak`, `flatpak-builder` : outils de base pour builder des applications Flatpak.
- `curl`, `git`, `gnupg`, etc. : outils usuels pour CI/CD.

---

## ğŸ“¦ Ã‰tape 2 â€“ CrÃ©er un volume de configuration GitLab Runner

```bash
podman volume create gitlab-runner-config
```

### ğŸ’¡ Pourquoi ?

Un volume Podman permet de stocker les fichiers de configuration du runner (`/etc/gitlab-runner`) **de maniÃ¨re persistante**, mÃªme si le conteneur est supprimÃ©.

---

## ğŸ”Œ Ã‰tape 3 â€“ Activer le socket Podman

```bash
sudo systemctl enable --now podman.socket
```

### ğŸ’¡ Pourquoi ?

Cette commande dÃ©marre un **daemon socket** qui permet Ã  dâ€™autres programmes (ici : le GitLab Runner) de communiquer avec Podman via `/run/podman/podman.sock`.

---

## ğŸ“¥ Ã‰tape 4 â€“ TÃ©lÃ©charger lâ€™image GitLab Runner

```bash
podman pull gitlab/gitlab-runner:latest
```

### ğŸ’¡ Pourquoi ?

On utilise lâ€™image officielle de GitLab Runner, qui contient le binaire `gitlab-runner` prÃªt Ã  lâ€™emploi.

---

## ğŸª Ã‰tape 5 â€“ Enregistrer le runner

```bash
podman run --rm -it \
  -v gitlab-runner-config:/etc/gitlab-runner \
  -v /run/podman/podman.sock:/run/podman/podman.sock \
  -e CONTAINER_HOST=unix:///run/podman/podman.sock \
  gitlab/gitlab-runner:latest register
```

### ğŸ’¡ Pourquoi ?

- `--rm -it` : conteneur temporaire interactif
- `-v gitlab-runner-config:/etc/gitlab-runner` : volume pour stocker la config
- `-v /run/podman/podman.sock:/...` : on **monte le socket de Podman** pour permettre au runner d'exÃ©cuter des conteneurs
- `-e CONTAINER_HOST=...` : permet au runner de connaÃ®tre lâ€™URL du socket

Pendant l'exÃ©cution, le runner vous demandera :

- Lâ€™URL GitLab (ex: `https://gitlab.example.com`)
- Le token dâ€™enregistrement
- Un nom/description pour identifier ce runner
- Les tags (ex: `flatpak`, `debian12`)
- Le type dâ€™exÃ©cuteur : rÃ©pondez `shell`

---

## ğŸš€ Ã‰tape 6 â€“ Lancer le runner en mode service

```bash
podman run -d --name gitlab-runner \
  --restart=always \
  -v gitlab-runner-config:/etc/gitlab-runner \
  -v /run/podman/podman.sock:/run/podman/podman.sock \
  -v /etc/passwd:/etc/passwd:ro \
  -v /etc/group:/etc/group:ro \
  -v /etc/subuid:/etc/subuid:ro \
  -v /etc/subgid:/etc/subgid:ro \
  -e CONTAINER_HOST=unix:///run/podman/podman.sock \
  gitlab/gitlab-runner:latest
```

### ğŸ’¡ Pourquoi ?

- `-d` : dÃ©marre le conteneur en arriÃ¨re-plan
- `--restart=always` : redÃ©marrage automatique aprÃ¨s reboot ou plantage
- Montages `/etc/{passwd,group,subuid,subgid}` : nÃ©cessaires pour que Podman comprenne lâ€™utilisateur dans le conteneur
- `-e CONTAINER_HOST` : configure le client Podman dans le runner

---

## ğŸ§ª Ã‰tape 7 â€“ Tester un job GitLab

Fichier `.gitlab-ci.yml` :

```yaml
flatpak-test:
  tags: [flatpak]
  script:
    - echo "Podman version: $(podman --version)"
    - echo "Flatpak version: $(flatpak --version)"
    - podman run --rm docker.io/library/alpine echo "OK"
```

### ğŸ’¡ Pourquoi ?

Ce test vÃ©rifie :
- que `podman` fonctionne dans les jobs
- que `flatpak` est accessible
- que le socket de Podman est bien fonctionnel depuis le conteneur du runner

---

## ğŸ§° Ã‰tape 8 â€“ (Optionnel) Image personnalisÃ©e avec Flatpak

Dockerfile :

```Dockerfile
FROM debian:12
RUN apt update && \
    apt install -y flatpak flatpak-builder podman fuse-overlayfs slirp4netns && \
    apt clean
```

### ğŸ’¡ Pourquoi ?

Permet dâ€™avoir une image dÃ©jÃ  prÃªte avec tous les outils nÃ©cessaires pour les jobs Flatpak, plutÃ´t que de les installer Ã  chaque job.

---

## ğŸ› ï¸ Ã‰tape 9 â€“ Lancer le runner comme service systemd (option)

```bash
podman generate systemd --name gitlab-runner --files --new
sudo mv container-gitlab-runner.service /etc/systemd/system/
sudo systemctl enable --now container-gitlab-runner.service
```

### ğŸ’¡ Pourquoi ?

Permet de sâ€™assurer que le GitLab Runner est **re-dÃ©marrÃ© automatiquement au boot** du systÃ¨me.

---

## ğŸ” Ã‰tape 10 â€“ Bonnes pratiques de sÃ©curitÃ©

- Utiliser des **tags** pour contrÃ´ler quels jobs utilisent ce runner
- Ne pas exposer ce runner Ã  des projets tiers si possible
- Valider les scripts utilisÃ©s dans les jobs (Ã©viter `rm -rf /` ğŸ˜…)
- Restreindre lâ€™accÃ¨s au socket Podman Ã  des utilisateurs de confiance

---

## âœ… RÃ©sumÃ© des points clÃ©s

| Ã‰lÃ©ment                  | DÃ©tail                                               |
|--------------------------|------------------------------------------------------|
| OS                       | Debian 12                                            |
| Conteneur runner         | gitlab/gitlab-runner                                 |
| Executor                 | `shell`                                              |
| Socket montÃ©             | `/run/podman/podman.sock`                            |
| Flatpak supportÃ©         | Via VM ou image personnalisÃ©e                        |
| Tags recommandÃ©s         | `flatpak`, `debian12`, `podman`                      |

---

## ğŸ“š RÃ©fÃ©rences

- [GitLab Runner](https://docs.gitlab.com/runner/)
- [Podman](https://podman.io/)
- [Flatpak](https://flatpak.org/)